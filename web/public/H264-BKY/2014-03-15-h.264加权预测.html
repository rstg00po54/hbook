

<!DOCTYPE html>
<html lang="en">
  <head>
    <title>h.264加权预测 现代 C++ 教程: 高速上手 C++ 11/14/17/20 - Modern C++ Tutorial: C++ 11/14/17/20 On the Fly</title>
    <meta charset="utf-8">
    <meta name="description" content="Modern C++ Tutorial | C++ 11/14/17/20 On the Fly | 现代 C++ 教程 | 高速上手 C++11/14/17/20">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="shortcut icon" type="image/x-icon" href="/modern-cpp/assets/cover-2nd.png">
    <meta name="msapplication-TileColor" content="#7e2d36">
    <meta name="theme-color" content="#7e2d36">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80889616-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-80889616-2');
    </script>

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono' rel='stylesheet' type='text/css'>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- main page styles -->
    
<link rel="stylesheet" href="/modern-cpp-tutorial/modern-cpp/css/page.css">


    <!-- this needs to be loaded before guide's inline scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script>window.PAGE_TYPE = ""</script>
    <script async src="//changkun.de/urlstat/client.js"></script>
  <meta name="generator" content="Hexo 7.3.0"></head>
  <body class="docs">
	<!-- body开始 -->
    
      <div id="mobile-bar" data-bg-text="现代 C++ 教程" >
        <a class="menu-button"></a>
        <a class="logo" href="/modern-cpp/"></a>
      </div>
    
    <div id="header">
  <a id="logo" href="/modern-cpp-tutorial/">
      <img src="/modern-cpp-tutorial/modern-cpp/assets/cover-2nd-logo.png">
      <span>教程：高速上手</span>
  </a>
  <ul id="nav">
    
      <li class="nav-dropdown-container resource">
  <a class="nav-link">资源</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><ul>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/zh-cn/00-preface/" >正文</a></li>
      <!-- TODO -->
      <!-- <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/code/1/" >代码</a></li>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/exercises/1/" >习题</a></li>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/answers/1/" >答案</a></li> -->
    </ul></li>
  </ul>
</li>

<li class="nav-dropdown-container about">
  <a class="nav-link">关于</a><span class="arrow"></span>
  <ul class="nav-dropdown">
      <li><ul>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/about/donate.html" >资助</a></li>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/about/copyright.html" >版权声明</a></li>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/about/ack.html" >致谢</a></li>
      </ul></li>
  </ul>
</li>

<li class="nav-dropdown-container language">
  <a class="nav-link">
    <span style="content: url(/modern-cpp/assets/lang/cn.svg); width: 15px; height: 15px; margin-right: 5px; vertical-align: middle; margin-bottom: 2px;"></span>
    中文
  </a><span class="arrow"></span>
  <ul class="nav-dropdown">
      <li><ul>
      <li><a class="nav-link" target="_blank" href="/modern-cpp/en-us/00-preface/">
        <span style="content: url(/modern-cpp/assets/lang/en.svg); width: 15px; height: 15px; margin-right: 5px; vertical-align: middle; margin-bottom: 2px;"></span>
        English
      </a></li>
      </ul></li>
  </ul>
</li>

<li class="nav-dropdown-container about">
  <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/changkun/modern-cpp-tutorial">GitHub</a>
</li>


    
  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
        
  <div class="sidebar">
    <ul class="main-menu">
        
          <li class="nav-dropdown-container resource">
  <a class="nav-link">资源</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><ul>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/zh-cn/00-preface/" >正文</a></li>
      <!-- TODO -->
      <!-- <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/code/1/" >代码</a></li>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/exercises/1/" >习题</a></li>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/answers/1/" >答案</a></li> -->
    </ul></li>
  </ul>
</li>

<li class="nav-dropdown-container about">
  <a class="nav-link">关于</a><span class="arrow"></span>
  <ul class="nav-dropdown">
      <li><ul>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/about/donate.html" >资助</a></li>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/about/copyright.html" >版权声明</a></li>
      <li><a class="nav-link" href="/modern-cpp-tutorial/modern-cpp/about/ack.html" >致谢</a></li>
      </ul></li>
  </ul>
</li>

<li class="nav-dropdown-container language">
  <a class="nav-link">
    <span style="content: url(/modern-cpp/assets/lang/cn.svg); width: 15px; height: 15px; margin-right: 5px; vertical-align: middle; margin-bottom: 2px;"></span>
    中文
  </a><span class="arrow"></span>
  <ul class="nav-dropdown">
      <li><ul>
      <li><a class="nav-link" target="_blank" href="/modern-cpp/en-us/00-preface/">
        <span style="content: url(/modern-cpp/assets/lang/en.svg); width: 15px; height: 15px; margin-right: 5px; vertical-align: middle; margin-bottom: 2px;"></span>
        English
      </a></li>
      </ul></li>
  </ul>
</li>

<li class="nav-dropdown-container about">
  <a class="nav-link" target="_blank" rel="noopener" href="https://github.com/changkun/modern-cpp-tutorial">GitHub</a>
</li>


        
    </ul>
  </div>

<div class="content  ">
  <p>帧间运动是基于视频亮度（luma）不发生改变的一个假设，而在视频序列中经常能遇到亮度变化的场景，比如淡入淡出、镜头光圈调整、整体或局部光源改变等，在这些场景中，简单帧间运动补偿的效果可想而知（实际编码中遇到亮度变化的宏块，R-D模型的最后结果通常都是用帧内预测编码），加权预测的提出就是为 了应对亮度变化的场景。<br>在h.264中两种预测模式：显示模式（explicit mode）与隐式模式（implicit mode），另外还有一种默认预测模式，不过这相当于不进行预测。<br>P帧与B帧都有显式模式，隐式模式只有B帧适用。至于怎么区分两种模式，简单来说，显式模式，需要在片头中传输权重（weight），而隐式模式则不需要。</p>
<p>加权预测可以分为三个步骤：</p>
<ol>
<li>亮度变化检测。一般是用阈值判断亮度是否发生变化。</li>
<li>确定权重与偏移。就目前来说，用的都是简单的加权预测算法，这步是跟亮度变化检测连在一起的，因为是用权重来判断亮度是否发生了变化。</li>
<li>亮度补偿，把参考帧通过权重与偏移的线性补偿得到加权参考帧。</li>
</ol>
<h4 id="显式模式"><a href="#显式模式" class="headerlink" title="显式模式"></a>显式模式</h4><p>对于显式模式来说，我们可以认为亮度在当前帧与参考帧是线性变化的，既有如下关系：<br>$LumaCur &#x3D; \frac {weight \times LumaRef + offset} {2^5}$<br>其中权重（weight）会被归一化为32(2^5)，因此我们就可以用weight与offset来表示两帧亮度的变化:<br>$weight &#x3D; 2^5 \cdot \frac {\sum {LumaCur_i}_j} {\sum {LumaRef_i}_j}    $<br>$\left{\begin{matrix}<br>0 \leq i &lt; imgWidth\<br>0 \leq j &lt; imgHeight<br>\end{matrix}\right.$<br>尽管这种用整个帧的亮度做比较会忽视图像的局部变化，但是由于其简单的计算方式，目前JM还是用的这种方法来得到权重。当然，在得到权重之后我们需要判断该权重是否超出既定的阈值，如果超出阈值则表示亮度没有发生变化，采用默认的加权预测（即不预测）。<br>$offset &#x3D; 0$    在JM中$offset$默认为0</p>
<h4 id="隐式模式"><a href="#隐式模式" class="headerlink" title="隐式模式"></a>隐式模式</h4><p>隐式模式也同样是基于亮度线性变化的假设。B帧与其两个参考帧：RefFront与RefBack在POC位置上保持着线性的关系<br><img src="//images0.cnblogs.com/i/421096/201403/152135095119800.jpg"><br>$\begin{align*}<br>weightBack &amp;&#x3D; 2^6 \cdot \frac {LengthFront} {LengthFront + LengthBack} \<br>weightFront &amp;&#x3D; 2^6 - weightBack<br>\end{align*}$</p>
<p>无论前向参考帧与后向参考帧距离有多长，最终都会归一化为64，然后求出两个参考帧的权重</p>
<p>最后的亮度补偿只是把参考帧用weight与offset进行线性处理而已<br><code>$&#123;&#123;Luma_i&#125;_j&#125;&#39; = \frac&#123;weight \times &#123;LumaRef_i&#125;_j + offset&#125; &#123;2^n&#125;$</code><br>最最后需要补充一句的是，因为当前还没确定应该用参考帧列表中的哪一帧作为当前帧的参考帧，所以加权预测必须对当前参考帧列表中的所有帧求出$weight$与$offset$，而隐式模式，更是需要对$listX[0]$与$listX[1]$两个参考帧列表中所有的帧进行$listXSize[0] \times listXSize[1]$次配对后，再分别求出每对参考帧的两个$weight$与$offset$</p>

  <div class="guide-links">
    
    
  </div>

  
    <div class="footer">
        <p>
          <a target="_blank" rel="noopener" href="https://changkun.de">欧长坤</a> &copy; 2016-2024 版权所有，
          采用<a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议许可</a>，代码使用 <a href="https://opensource.org/licenses/MIT" target="_blank">MIT</a> 协议开源。</a>
        </p>
        <p>
            如果你认为本书对你起到了帮助，可以<a href="/modern-cpp/about/donate.html">资助作者</a>。
        </p>
      </div>
  


</div>

      </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smooth-scroll/10.2.1/js/smooth-scroll.min.js"></script>

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="https://cdn.jsdelivr.net/npm/css.escape@1.5.1/css.escape.min.js"></script>
    <script src="/modern-cpp-tutorial/modern-cpp/js/common.js"></script>

    <!-- fastclick -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      FastClick.attach(document.body)
    }, false)
    </script>
  </body>
</html>
